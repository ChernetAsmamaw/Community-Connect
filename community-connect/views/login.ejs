<%- include('partials/header'); -%>
<form id="loginForm">
  <h2>Login</h2>

  <label for="identifier">Username or Email</label>
  <input type="text" name="identifier" id="identifier" required />
  <div class="identifier error"></div>

  <label for="password">Password</label>
  <input type="password" name="password" id="password" required />
  <div class="password error"></div>

  <button type="submit">Login</button>
</form>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("loginForm");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      // Clear any previous error messages
      document.querySelector(".identifier.error").textContent = "";
      document.querySelector(".password.error").textContent = "";

      // Get the form values
      const identifier = document.getElementById("identifier").value;
      const password = document.getElementById("password").value;

      try {
        const res = await fetch("/login", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ identifier, password }),
        });

        // Check for successful response
        if (res.ok) {
          const data = await res.json();

          // Handle server response errors
          if (data.errors) {
            const identifierError = document.querySelector(".identifier.error");
            const passwordError = document.querySelector(".password.error");

            if (data.errors.identifier) {
              identifierError.textContent = data.errors.identifier;
            }
            if (data.errors.password) {
              passwordError.textContent = data.errors.password;
            }
          } else if (data.user) {
            // Redirect if login is successful
            window.location.assign("/");
          }
        } else {
          // Handle general server error (non-JSON responses, etc.)
          const errorMessage = await res.text();
          console.error("Server Error:", errorMessage);
        }
      } catch (error) {
        // Handle any network errors
        console.error("Network Error:", error);
      }
    });
  });
</script>

<%- include('partials/footer'); -%>
